<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehat Sethu - Ultimate Health Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Root Variables for Advanced Theming --- */
        :root {
            /* Light Theme Colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --sidebar-bg: #ffffff;
            --sidebar-hover: #f1f5f9;
            --sidebar-active: #3b82f6;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --accent-primary: #3b82f6;
            --accent-secondary: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .dark-theme {
            /* Dark Theme Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --sidebar-bg: #1e293b;
            --sidebar-hover: #334155;
            --sidebar-active: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-light: #334155;
            --border-medium: #475569;
            --accent-primary: #3b82f6;
            --accent-secondary: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
        }

        /* --- Global Styles --- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* --- Advanced Sidebar --- */
        /* Sidebar default */
.sidebar {
  width: 220px;
  transition: width 0.3s ease;
  overflow: hidden;
}

/* Collapsed sidebar */
.sidebar.collapsed {
  width: 60px;
}

/* Sidebar text fades out when collapsed */
.sidebar .sidebar-item span,
.sidebar h1 {
  opacity: 1;
  transition: opacity 0.2s ease;
  white-space: nowrap;
}

.sidebar.collapsed .sidebar-item span,
.sidebar.collapsed h1 {
  opacity: 0;
  pointer-events: none;
}

/* Align icons to center when collapsed */
.sidebar.collapsed .sidebar-item i {
  margin-right: 0;
  text-align: center;
  width: 100%;
}

/* Main content shifts */
.main-content {
  margin-left: 220px;
  transition: margin-left 0.3s ease;
}

.main-content.collapsed {
  margin-left: 60px;
}

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-light);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: var(--border-medium);
            border-radius: 3px;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-header .logo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-header h1 {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .sidebar-toggle {
        
            /* Keep toggle always visible when collapsed */
            .sidebar.collapsed .sidebar-toggle {
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 1010; /* above sidebar content */
            }
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background-color: var(--sidebar-hover);
            color: var(--text-primary);
        }

        .sidebar-menu {
            padding: 1rem 0;
            list-style: none;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 0.25rem 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 0;
            position: relative;
        }

        .sidebar-menu a i {
            width: 20px;
            text-align: center;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .sidebar-menu a:hover {
            background-color: var(--sidebar-hover);
            color: var(--text-primary);
        }

        .sidebar-menu a.active {
            background-color: var(--sidebar-active);
            color: white;
            font-weight: 500;
        }

        .sidebar-menu a.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--accent-secondary);
        }

        .sidebar.collapsed .sidebar-menu a span {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-menu a i {
            margin-right: 0;
        }

        /* --- Wellness Tips Card --- */
        .wellness-tips {
            margin: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 1rem;
            color: white;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .wellness-tips h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .wellness-tips p {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .sidebar.collapsed .wellness-tips {
            display: none;
        }

        /* --- Main Content Area --- */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            background-color: var(--bg-primary);
        }

        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }

        .content-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .content-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-medium);
            transition: 0.4s;
            border-radius: 34px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .theme-toggle input:checked + .theme-slider {
            background-color: var(--accent-primary);
        }

        .theme-toggle input:checked + .theme-slider:before {
            transform: translateX(26px);
        }

        .content-body {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Advanced Card Components --- */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        /* --- Form Components --- */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: 0.5rem;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* --- Button Components --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--accent-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background-color: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-outline:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        /* --- Chat Interface --- */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--border-medium);
            border-radius: 3px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .message.bot .message-avatar {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .message-content {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            box-shadow: var(--shadow-sm);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
        }

        .message-text {
            margin: 0;
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input-container {
            padding: 1.5rem;
            border-top: 1px solid var(--border-light);
            background-color: var(--bg-secondary);
        }

        .chat-input-form {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: 1.5rem;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Loading States --- */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .thinking-dots {
            display: flex;
            gap: 0.25rem;
        }

        .thinking-dot {
            width: 6px;
            height: 6px;
            background-color: var(--text-muted);
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* --- Notification System --- */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--accent-secondary);
        }

        .notification.error {
            border-left: 4px solid var(--accent-danger);
        }

        .notification.warning {
            border-left: 4px solid var(--accent-warning);
        }

        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
        }

        .notification-message {
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        /* --- Modal System --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* --- Data Lists --- */
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .data-item {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .data-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .data-item-content {
            flex: 1;
        }

        .data-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
        }

        .data-item-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }

        .data-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* --- BMI Calculator --- */
        .bmi-calculator {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .bmi-result {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .bmi-category {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-header {
                padding: 1rem;
            }

            .content-body {
                padding: 1rem;
            }

            .chat-container {
                height: calc(100vh - 120px);
            }

            .message {
                max-width: 90%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }

        /* --- Animations --- */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-medium {
            font-weight: 500;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-0 {
            margin-top: 0;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mt-6 {
            margin-top: 1.5rem;
        }

        .p-0 {
            padding: 0;
        }

        .p-1 {
            padding: 0.25rem;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .transition {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
    </style>
</head>

<body class="bg-gray-100 dark-theme-toggle">

    <div class="flex">
        <aside class="sidebar bg-white shadow-lg flex-shrink-0">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="/static/logo.png" alt="Logo" class="w-10 h-10">
                    <h1 class="font-bold text-xl text-gray-900 dark:text-gray-100">Sehat Sethu</h1>
                </div>
                <button id="sidebar-toggle" class="sidebar-toggle text-gray-600 dark:text-gray-400 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#dashboard-section" class="sidebar-item active" data-section="dashboard-section"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                    <li><a href="#chat-section" class="sidebar-item" data-section="chat-section"><i class="fas fa-comment-dots"></i> <span>Chat</span></a></li>
                    <li><a href="#medication-section" class="sidebar-item" data-section="medication-section"><i class="fas fa-pills"></i> <span>Medication</span></a></li>
                    <li><a href="#appointments-section" class="sidebar-item" data-section="appointments-section"><i class="fas fa-calendar-alt"></i> <span>Appointments</span></a></li>
                    <li><a href="#emergency-section" class="sidebar-item" data-section="emergency-section"><i class="fas fa-phone-volume"></i> <span>Emergency Contacts</span></a></li>
                    <li><a href="#profile-section" class="sidebar-item" data-section="profile-section"><i class="fas fa-user-circle"></i> <span>My Profile</span></a></li>
                    <li><a href="#doctors-section" class="sidebar-item" data-section="doctors-section"><i class="fas fa-user-md"></i> <span>Find Doctors</span></a></li>
                </ul>
            </nav>
            <div class="wellness-tips">
                <h4>Wellness Tip of the Day</h4>
                <p>Stay hydrated! Drinking enough water can boost your energy and improve your focus.</p>
            </div>
        </aside>

        <main class="main-content flex-grow transition-all duration-300">
            <header class="content-header bg-white shadow-sm flex items-center justify-between p-4 sticky top-0 z-10">
                <h2 id="section-title" class="content-title text-2xl font-bold text-gray-800">Dashboard</h2>
                <div class="theme-toggle-container">
                    <label class="theme-toggle">
                        <input type="checkbox" id="theme-toggle">
                        <span class="theme-slider"></span>
                    </label>
                    <i class="fas fa-sun text-yellow-500 text-xl"></i>
                    <i class="fas fa-moon text-blue-700 text-xl"></i>
                </div>
            </header>

            <div class="content-body p-6">
                <section id="dashboard-section" class="dashboard-section section active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="card p-6 rounded-xl shadow-lg">
                            <div class="card-header border-b border-gray-200 pb-4 mb-4">
                                <h3 class="card-title text-xl font-semibold text-gray-800">Your Profile</h3>
                                <div class="card-icon bg-blue-500 text-white rounded-full w-12 h-12 flex items-center justify-center">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                            <div class="card-body text-gray-600">
                                <p id="profile-name">Name: N/A</p>
                                <p id="profile-dob">Date of Birth: N/A</p>
                                <p id="profile-gender">Gender: N/A</p>
                                <p id="profile-blood-group">Blood Group: N/A</p>
                            </div>
                            <div class="card-footer mt-4 text-right">
                                <button id="edit-profile-btn" class="btn btn-outline btn-sm">Edit Profile</button>
                            </div>
                        </div>

                        <div class="card p-6 rounded-xl shadow-lg">
                            <div class="card-header border-b border-gray-200 pb-4 mb-4">
                                <h3 class="card-title text-xl font-semibold text-gray-800">Upcoming Appointments</h3>
                                <div class="card-icon bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                            <div class="card-body text-gray-600">
                                <ul id="upcoming-appointments-list" class="list-disc pl-5">
                                    </ul>
                                <p id="no-appointments" class="text-gray-500 italic">No upcoming appointments.</p>
                            </div>
                            <div class="card-footer mt-4 text-right">
                                <button id="add-appointment-btn" class="btn btn-primary btn-sm">Add Appointment</button>
                            </div>
                        </div>

                        <div class="card p-6 rounded-xl shadow-lg">
                            <div class="card-header border-b border-gray-200 pb-4 mb-4">
                                <h3 class="card-title text-xl font-semibold text-gray-800">Emergency Contacts</h3>
                                <div class="card-icon bg-red-500 text-white rounded-full w-12 h-12 flex items-center justify-center">
                                    <i class="fas fa-first-aid"></i>
                                </div>
                            </div>
                            <div class="card-body text-gray-600">
                                <ul id="emergency-contacts-list" class="list-disc pl-5">
                                    </ul>
                                <p id="no-contacts" class="text-gray-500 italic">No emergency contacts saved.</p>
                            </div>
                            <div class="card-footer mt-4 text-right">
                                <button id="add-contact-btn" class="btn btn-primary btn-sm">Add Contact</button>
                            </div>
                        </div>
                    </div>
                    <div class="bmi-calculator">
                        <h3 class="text-2xl font-bold mb-4">BMI Calculator</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="weight" class="form-label text-white">Weight (kg)</label>
                                <input type="number" id="weight" class="form-input" placeholder="e.g., 70">
                            </div>
                            <div class="form-group">
                                <label for="height" class="form-label text-white">Height (cm)</label>
                                <input type="number" id="height" class="form-input" placeholder="e.g., 175">
                            </div>
                        </div>
                        <button id="calculate-bmi-btn" class="btn btn-secondary mt-4 w-full">Calculate BMI</button>
                        <div id="bmi-result-card" class="bmi-result hidden mt-6">
                            <p>Your BMI is: <span id="bmi-value" class="font-bold"></span></p>
                            <p class="bmi-category"><span id="bmi-category"></span></p>
                        </div>
                    </div>
                </section>

                <section id="chat-section" class="chat-section section hidden">
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            </div>
                        <div class="chat-input-container">
                            <form id="chat-form" class="chat-input-form">
                                <textarea id="chat-input" class="chat-input" placeholder="Type your medical query..." rows="1" required></textarea>
                                <button type="submit" id="chat-send-btn" class="chat-send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <section id="medication-section" class="medication-section section hidden">
                    <div class="card p-6 rounded-xl shadow-lg">
                        <div class="card-header">
                            <h3 class="card-title">My Medications</h3>
                            <button id="add-medication-btn" class="btn btn-primary btn-sm">Add New</button>
                        </div>
                        <div id="medication-list" class="data-list">
                            </div>
                        <p id="no-medications" class="text-gray-500 italic text-center mt-4 hidden">No medications added yet.</p>
                    </div>
                </section>

                <section id="appointments-section" class="appointments-section section hidden">
                    <div class="card p-6 rounded-xl shadow-lg">
                        <div class="card-header">
                            <h3 class="card-title">My Appointments</h3>
                            <button id="add-appointment-btn-full" class="btn btn-primary btn-sm">Add New</button>
                        </div>
                        <div id="appointment-list" class="data-list">
                            </div>
                        <p id="no-appointments-full" class="text-gray-500 italic text-center mt-4 hidden">No appointments added yet.</p>
                    </div>
                </section>

                <section id="emergency-section" class="emergency-section section hidden">
                    <div class="card p-6 rounded-xl shadow-lg">
                        <div class="card-header">
                            <h3 class="card-title">My Emergency Contacts</h3>
                            <button id="add-contact-btn-full" class="btn btn-primary btn-sm">Add New</button>
                        </div>
                        <div id="emergency-contact-list" class="data-list">
                            </div>
                        <p id="no-emergency-contacts" class="text-gray-500 italic text-center mt-4 hidden">No emergency contacts added yet.</p>
                    </div>
                </section>

                <section id="profile-section" class="profile-section section hidden">
                    <div class="card p-6 rounded-xl shadow-lg">
                        <h3 class="card-title mb-4">Edit Profile</h3>
                        <form id="profile-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="profile-name-input" class="form-label">Full Name</label>
                                    <input type="text" id="profile-name-input" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="profile-dob-input" class="form-label">Date of Birth</label>
                                    <input type="date" id="profile-dob-input" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="profile-gender-input" class="form-label">Gender</label>
                                    <input type="text" id="profile-gender-input" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="profile-blood-group-input" class="form-label">Blood Group</label>
                                    <input type="text" id="profile-blood-group-input" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="profile-conditions-input" class="form-label">Known Conditions</label>
                                    <input type="text" id="profile-conditions-input" class="form-input" placeholder="e.g., Diabetes, Hypertension">
                                </div>
                            </div>
                            <div class="text-right mt-6">
                                <button type="submit" class="btn btn-primary">Save Profile</button>
                            </div>
                        </form>
                    </div>
                </section>
                
                <section id="doctors-section" class="doctors-section section hidden">
                    <div class="card p-6 rounded-xl shadow-lg">
                        <h3 class="card-title mb-4">Find a Doctor</h3>
                        <div class="form-group">
                            <label for="specialty-filter" class="form-label">Filter by Specialty</label>
                            <select id="specialty-filter" class="form-input">
                                <option value="">All Specialties</option>
                            </select>
                        </div>
                        <div id="doctor-list" class="data-list mt-4">
                             </div>
                        <p id="no-doctors" class="text-gray-500 italic text-center mt-4 hidden">No doctors found.</p>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <div id="medication-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="medication-modal-title" class="modal-title">Add Medication</h3>
                <button class="modal-close" data-modal-target="medication-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="medication-form">
                    <input type="hidden" id="medication-id">
                    <div class="form-group">
                        <label for="medication-name-input" class="form-label">Medication Name</label>
                        <input type="text" id="medication-name-input" class="form-input" required>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="medication-dosage-input" class="form-label">Dosage</label>
                            <input type="text" id="medication-dosage-input" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="medication-frequency-input" class="form-label">Frequency</label>
                            <input type="text" id="medication-frequency-input" class="form-input" placeholder="e.g., Twice a day" required>
                        </div>
                        <div class="form-group">
                            <label for="medication-time-input" class="form-label">Time of Day</label>
                            <input type="time" id="medication-time-input" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="medication-notes-input" class="form-label">Notes (optional)</label>
                            <textarea id="medication-notes-input" class="form-input"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close" data-modal-target="medication-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="appointment-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="appointment-modal-title" class="modal-title">Add Appointment</h3>
                <button class="modal-close" data-modal-target="appointment-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="appointment-form">
                    <input type="hidden" id="appointment-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="appointment-doctor-input" class="form-label">Doctor's Name</label>
                            <input type="text" id="appointment-doctor-input" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="appointment-date-input" class="form-label">Date</label>
                            <input type="date" id="appointment-date-input" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="appointment-time-input" class="form-label">Time</label>
                            <input type="time" id="appointment-time-input" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="appointment-location-input" class="form-label">Location</label>
                            <input type="text" id="appointment-location-input" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appointment-notes-input" class="form-label">Notes (optional)</label>
                        <textarea id="appointment-notes-input" class="form-input"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close" data-modal-target="appointment-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="emergency-contact-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="emergency-contact-modal-title" class="modal-title">Add Emergency Contact</h3>
                <button class="modal-close" data-modal-target="emergency-contact-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="emergency-contact-form">
                    <input type="hidden" id="contact-id">
                    <div class="form-group">
                        <label for="contact-name-input" class="form-label">Name</label>
                        <input type="text" id="contact-name-input" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-relationship-input" class="form-label">Relationship</label>
                        <input type="text" id="contact-relationship-input" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-phone-input" class="form-label">Phone Number</label>
                        <input type="tel" id="contact-phone-input" class="form-input" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close" data-modal-target="emergency-contact-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div id="notifications-container"></div>

    <script>
        const app = {
            data: {
                profile: {},
                appointments: [],
                emergency_contacts: [],
                medications: [],
                chat_history: []
            },
            elements: {
                // Sections
                sections: document.querySelectorAll('.section'),
                dashboardSection: document.getElementById('dashboard-section'),
                medicationList: document.getElementById('medication-list'),
                appointmentList: document.getElementById('appointment-list'),
                emergencyContactList: document.getElementById('emergency-contact-list'),
                doctorList: document.getElementById('doctor-list'),
                noMedications: document.getElementById('no-medications'),
                noAppointments: document.getElementById('no-appointments'),
                noAppointmentsFull: document.getElementById('no-appointments-full'),
                noContacts: document.getElementById('no-contacts'),
                noEmergencyContacts: document.getElementById('no-emergency-contacts'),
                noDoctors: document.getElementById('no-doctors'),
                specialtyFilter: document.getElementById('specialty-filter'),

                // Navigation
                sidebar: document.querySelector('.sidebar'),
                sidebarToggle: document.getElementById('sidebar-toggle'),
                sidebarItems: document.querySelectorAll('.sidebar-item'),
                sectionTitle: document.getElementById('section-title'),

                // Modals
                medicationModal: document.getElementById('medication-modal'),
                appointmentModal: document.getElementById('appointment-modal'),
                emergencyContactModal: document.getElementById('emergency-contact-modal'),
                modalOverlays: document.querySelectorAll('.modal-overlay'),

                // Forms
                profileForm: document.getElementById('profile-form'),
                medicationForm: document.getElementById('medication-form'),
                appointmentForm: document.getElementById('appointment-form'),
                emergencyContactForm: document.getElementById('emergency-contact-form'),
                chatForm: document.getElementById('chat-form'),

                // Inputs
                chatInput: document.getElementById('chat-input'),
                themeToggle: document.getElementById('theme-toggle'),

                // Buttons
                addMedicationBtn: document.getElementById('add-medication-btn'),
                addAppointmentBtn: document.getElementById('add-appointment-btn'),
                addAppointmentBtnFull: document.getElementById('add-appointment-btn-full'),
                addContactBtn: document.getElementById('add-contact-btn'),
                addContactBtnFull: document.getElementById('add-contact-btn-full'),
                editProfileBtn: document.getElementById('edit-profile-btn'),
                calculateBmiBtn: document.getElementById('calculate-bmi-btn'),

                // Chat
                chatMessages: document.getElementById('chat-messages'),

                // Notifications
                notificationsContainer: document.getElementById('notifications-container'),
            },

            // --- Core Functions ---
            async init() {
                await this.fetchData();
                this.renderAll();
                this.setupEventListeners();
                this.setupThemeToggle();
            },

            // --- Data Fetching & Rendering ---
            async fetchData() {
                try {
                    const response = await fetch('/data');
                    if (response.ok) {
                        const data = await response.json();
                        this.data = {
                            profile: data.profile || {},
                            appointments: data.appointments || [],
                            emergency_contacts: data.emergency_contacts || [],
                            medications: data.medications || [],
                            chat_history: data.chat_history || [],
                            doctors: data.doctors || []
                        };
                    } else {
                        throw new Error("Failed to fetch data.");
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                    this.showNotification("Failed to load user data.", 'error');
                }
            },

            async saveData() {
                try {
                    const response = await fetch('/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data)
                    });
                    if (!response.ok) {
                        throw new Error("Failed to save data.");
                    }
                } catch (error) {
                    console.error("Error saving data:", error);
                    this.showNotification("Failed to save changes.", 'error');
                }
            },

            renderAll() {
                this.renderProfile();
                this.renderMedications();
                this.renderAppointments();
                this.renderEmergencyContacts();
                this.renderDoctors();
                this.renderChatHistory();
            },

            // --- UI Rendering Functions ---
            renderProfile() {
                const p = this.data.profile;
                document.getElementById('profile-name').textContent = `Name: ${p.name || 'N/A'}`;
                document.getElementById('profile-dob').textContent = `Date of Birth: ${p.dob || 'N/A'}`;
                document.getElementById('profile-gender').textContent = `Gender: ${p.gender || 'N/A'}`;
                document.getElementById('profile-blood-group').textContent = `Blood Group: ${p.blood_group || 'N/A'}`;

                // Fill profile form
                document.getElementById('profile-name-input').value = p.name || '';
                document.getElementById('profile-dob-input').value = p.dob || '';
                document.getElementById('profile-gender-input').value = p.gender || '';
                document.getElementById('profile-blood-group-input').value = p.blood_group || '';
                document.getElementById('profile-conditions-input').value = p.conditions || '';
            },

            renderMedications() {
                const list = this.elements.medicationList;
                const noMedications = this.elements.noMedications;
                list.innerHTML = '';
                if (this.data.medications.length === 0) {
                    noMedications.classList.remove('hidden');
                } else {
                    noMedications.classList.add('hidden');
                    this.data.medications.forEach(med => {
                        const item = document.createElement('div');
                        item.classList.add('data-item', 'fade-in');
                        item.innerHTML = `
                            <div class="data-item-content">
                                <h4 class="data-item-title">${med.name}</h4>
                                <p class="data-item-subtitle">${med.dosage} &middot; ${med.frequency}</p>
                            </div>
                            <div class="data-item-actions">
                                <button class="btn btn-outline btn-sm" onclick="app.editMedication('${med.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteMedication('${med.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            },

            renderAppointments() {
                const dashboardList = document.getElementById('upcoming-appointments-list');
                const fullList = this.elements.appointmentList;
                const noAppointmentsDashboard = document.getElementById('no-appointments');
                const noAppointmentsFull = this.elements.noAppointmentsFull;

                dashboardList.innerHTML = '';
                fullList.innerHTML = '';

                if (this.data.appointments.length === 0) {
                    noAppointmentsDashboard.classList.remove('hidden');
                    noAppointmentsFull.classList.remove('hidden');
                } else {
                    noAppointmentsDashboard.classList.add('hidden');
                    noAppointmentsFull.classList.add('hidden');

                    const now = new Date();
                    const sortedAppointments = this.data.appointments.sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));

                    sortedAppointments.forEach(appt => {
                        const apptDateTime = new Date(`${appt.date}T${appt.time}`);
                        const isUpcoming = apptDateTime > now;

                        // Render for Dashboard
                        if (isUpcoming) {
                            const dashboardItem = document.createElement('li');
                            dashboardItem.textContent = `${appt.doctor} on ${appt.date} at ${appt.time}`;
                            dashboardList.appendChild(dashboardItem);
                        }

                        // Render for Full List
                        const fullItem = document.createElement('div');
                        fullItem.classList.add('data-item', 'fade-in');
                        fullItem.innerHTML = `
                            <div class="data-item-content">
                                <h4 class="data-item-title">Dr. ${appt.doctor}</h4>
                                <p class="data-item-subtitle">${appt.location || 'N/A'} &middot; ${appt.date} at ${appt.time}</p>
                            </div>
                            <div class="data-item-actions">
                                <button class="btn btn-outline btn-sm" onclick="app.editAppointment('${appt.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteAppointment('${appt.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        fullList.appendChild(fullItem);
                    });
                }
            },

            renderEmergencyContacts() {
                const list = this.elements.emergencyContactList;
                const noContacts = this.elements.noEmergencyContacts;
                list.innerHTML = '';
                if (this.data.emergency_contacts.length === 0) {
                    noContacts.classList.remove('hidden');
                    this.elements.noContacts.classList.remove('hidden');
                } else {
                    noContacts.classList.add('hidden');
                    this.elements.noContacts.classList.add('hidden');
                    this.data.emergency_contacts.forEach(contact => {
                        const item = document.createElement('div');
                        item.classList.add('data-item', 'fade-in');
                        item.innerHTML = `
                            <div class="data-item-content">
                                <h4 class="data-item-title">${contact.name}</h4>
                                <p class="data-item-subtitle">${contact.relationship} &middot; ${contact.phone}</p>
                            </div>
                            <div class="data-item-actions">
                                <button class="btn btn-outline btn-sm" onclick="app.editEmergencyContact('${contact.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteEmergencyContact('${contact.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            },

            renderDoctors() {
                const list = this.elements.doctorList;
                const filter = this.elements.specialtyFilter;
                const noDoctors = this.elements.noDoctors;
                list.innerHTML = '';

                const specialties = new Set();
                this.data.doctors.forEach(doc => specialties.add(doc.specialty));
                filter.innerHTML = `<option value="">All Specialties</option>` + [...specialties].map(s => `<option value="${s}">${s}</option>`).join('');

                const selectedSpecialty = filter.value;
                const filteredDoctors = this.data.doctors.filter(doc => !selectedSpecialty || doc.specialty === selectedSpecialty);

                if (filteredDoctors.length === 0) {
                    noDoctors.classList.remove('hidden');
                } else {
                    noDoctors.classList.add('hidden');
                    filteredDoctors.forEach(doc => {
                        const item = document.createElement('div');
                        item.classList.add('data-item', 'fade-in');
                        item.innerHTML = `
                            <div class="data-item-content">
                                <h4 class="data-item-title">${doc.name}</h4>
                                <p class="data-item-subtitle">${doc.specialty} &middot; ${doc.hospital}, ${doc.location}</p>
                                <p class="text-sm text-gray-400 mt-2">Phone: ${doc.phone}</p>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            },

            renderChatHistory() {
                const chatMessages = this.elements.chatMessages;
                chatMessages.innerHTML = '';
                this.data.chat_history.forEach(msg => {
                    this.addMessageToChat('user', msg.user, msg.timestamp);
                    this.addMessageToChat('bot', marked.parse(msg.bot), msg.timestamp);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },

            addMessageToChat(sender, text, timestamp) {
                const chatMessages = this.elements.chatMessages;
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', sender);
                const avatar = sender === 'user' ? 'You' : 'AI';
                messageEl.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                        <div class="message-time">${this.formatTimestamp(timestamp)}</div>
                    </div>
                `;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },

            // --- Event Handlers & Actions ---
            setupEventListeners() {
                // Sidebar Navigation
                this.elements.sidebarItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.elements.sidebarItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.elements.sections.forEach(s => s.classList.add('hidden'));
                        const targetSection = document.getElementById(item.dataset.section);
                        targetSection.classList.remove('hidden');
                        this.elements.sectionTitle.textContent = item.querySelector('span').textContent;
                        if (item.dataset.section === 'chat-section') {
                            this.elements.chatInput.focus();
                        }
                    });
                });

                // Sidebar Toggle
                this.elements.sidebarToggle.addEventListener('click', () => {
                    this.elements.sidebar.classList.toggle('collapsed');
                    document.querySelector('.main-content').classList.toggle('collapsed');
                });

                // Profile
                this.elements.editProfileBtn.addEventListener('click', () => {
                    this.elements.sidebarItems.forEach(i => i.classList.remove('active'));
                    document.querySelector('[data-section="profile-section"]').classList.add('active');
                    this.elements.sections.forEach(s => s.classList.add('hidden'));
                    this.elements.profileSection.classList.remove('hidden');
                    this.elements.sectionTitle.textContent = 'My Profile';
                });
                this.elements.profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    this.data.profile = {
                        name: document.getElementById('profile-name-input').value,
                        dob: document.getElementById('profile-dob-input').value,
                        gender: document.getElementById('profile-gender-input').value,
                        blood_group: document.getElementById('profile-blood-group-input').value,
                        conditions: document.getElementById('profile-conditions-input').value
                    };
                    await this.saveData();
                    this.renderProfile();
                    this.showNotification("Profile updated successfully!", 'success');
                });

                // Medication
                this.elements.addMedicationBtn.addEventListener('click', () => {
                    this.openMedicationModal();
                });
                this.elements.medicationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.saveMedication();
                });

                // Appointment
                this.elements.addAppointmentBtn.addEventListener('click', () => {
                    this.openAppointmentModal();
                });
                this.elements.addAppointmentBtnFull.addEventListener('click', () => {
                    this.openAppointmentModal();
                });
                this.elements.appointmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.saveAppointment();
                });

                // Emergency Contact
                this.elements.addContactBtn.addEventListener('click', () => {
                    this.openEmergencyContactModal();
                });
                this.elements.addContactBtnFull.addEventListener('click', () => {
                    this.openEmergencyContactModal();
                });
                this.elements.emergencyContactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.saveEmergencyContact();
                });
                
                // Modal Close Buttons
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetId = btn.dataset.modalTarget;
                        document.getElementById(targetId).classList.remove('show');
                    });
                });


                // Chat
                this.elements.chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userInput = this.elements.chatInput.value.trim();
                    if (userInput) {
                        this.elements.chatInput.value = '';
                        this.elements.chatInput.style.height = 'auto'; // Reset textarea height
                        this.addMessageToChat('user', userInput, new Date().toISOString());

                        // Simulate thinking state
                        const thinkingEl = document.createElement('div');
                        thinkingEl.classList.add('message', 'bot', 'thinking-indicator');
                        thinkingEl.innerHTML = `<div class="message-avatar">AI</div><div class="message-content">AI is thinking<span class="thinking-dots"><span class="thinking-dot"></span><span class="thinking-dot"></span><span class="thinking-dot"></span></span></div>`;
                        this.elements.chatMessages.appendChild(thinkingEl);
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;

                        const response = await fetch('/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: userInput })
                        });
                        const data = await response.json();
                        thinkingEl.remove(); // Remove thinking indicator
                        if (data.error) {
                            this.addMessageToChat('bot', `An error occurred: ${data.error}`, new Date().toISOString());
                        } else {
                            this.addMessageToChat('bot', marked.parse(data.bot_message), new Date().toISOString());
                            this.data.chat_history.push({ user: userInput, bot: data.bot_message, timestamp: new Date().toISOString() });
                            await this.saveData();
                        }
                    }
                });

                this.elements.chatInput.addEventListener('input', () => {
                    this.elements.chatInput.style.height = 'auto';
                    this.elements.chatInput.style.height = this.elements.chatInput.scrollHeight + 'px';
                });
                
                // BMI
                this.elements.calculateBmiBtn.addEventListener('click', () => this.calculateBmi());

                // Doctor Filter
                this.elements.specialtyFilter.addEventListener('change', () => this.renderDoctors());
            },

            // --- CRUD Operations ---
            async saveMedication() {
                const form = this.elements.medicationForm;
                const id = form.querySelector('#medication-id').value;
                const medication = {
                    name: form.querySelector('#medication-name-input').value,
                    dosage: form.querySelector('#medication-dosage-input').value,
                    frequency: form.querySelector('#medication-frequency-input').value,
                    time: form.querySelector('#medication-time-input').value,
                    notes: form.querySelector('#medication-notes-input').value
                };

                let url = '/medications';
                let method = 'POST';

                if (id) {
                    url = `/medications/${id}`;
                    method = 'PUT';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(medication)
                    });

                    if (response.ok) {
                        const savedMedication = await response.json();
                        if (method === 'POST') {
                            this.data.medications.push(savedMedication);
                            this.showNotification("Medication added successfully!", 'success');
                        } else {
                            const index = this.data.medications.findIndex(m => m.id === id);
                            if (index !== -1) {
                                this.data.medications[index] = savedMedication;
                                this.showNotification("Medication updated successfully!", 'success');
                            }
                        }
                        this.closeModal('medication-modal');
                        this.renderMedications();
                    } else {
                        throw new Error("Failed to save medication.");
                    }
                } catch (error) {
                    console.error("Error saving medication:", error);
                    this.showNotification("Failed to save medication.", 'error');
                }
            },

            editMedication(id) {
                const medication = this.data.medications.find(m => m.id === id);
                if (medication) {
                    this.elements.medicationForm.querySelector('#medication-id').value = medication.id;
                    this.elements.medicationForm.querySelector('#medication-name-input').value = medication.name;
                    this.elements.medicationForm.querySelector('#medication-dosage-input').value = medication.dosage;
                    this.elements.medicationForm.querySelector('#medication-frequency-input').value = medication.frequency;
                    this.elements.medicationForm.querySelector('#medication-time-input').value = medication.time;
                    this.elements.medicationForm.querySelector('#medication-notes-input').value = medication.notes;
                    document.getElementById('medication-modal-title').textContent = 'Edit Medication';
                    this.openModal('medication-modal');
                }
            },

            async deleteMedication(id) {
                if (!confirm("Are you sure you want to delete this medication?")) return;
                try {
                    const response = await fetch(`/medications/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        this.data.medications = this.data.medications.filter(m => m.id !== id);
                        this.renderMedications();
                        this.showNotification("Medication deleted successfully!", 'success');
                    } else {
                        throw new Error("Failed to delete medication.");
                    }
                } catch (error) {
                    console.error("Error deleting medication:", error);
                    this.showNotification("Failed to delete medication.", 'error');
                }
            },

            async saveAppointment() {
                const form = this.elements.appointmentForm;
                const id = form.querySelector('#appointment-id').value;
                const appointment = {
                    doctor: form.querySelector('#appointment-doctor-input').value,
                    date: form.querySelector('#appointment-date-input').value,
                    time: form.querySelector('#appointment-time-input').value,
                    location: form.querySelector('#appointment-location-input').value,
                    notes: form.querySelector('#appointment-notes-input').value
                };

                let url = '/appointments';
                let method = 'POST';

                if (id) {
                    url = `/appointments/${id}`;
                    method = 'PUT';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appointment)
                    });

                    if (response.ok) {
                        const savedAppointment = await response.json();
                        if (method === 'POST') {
                            this.data.appointments.push(savedAppointment);
                            this.showNotification("Appointment added successfully!", 'success');
                        } else {
                            const index = this.data.appointments.findIndex(a => a.id === id);
                            if (index !== -1) {
                                this.data.appointments[index] = savedAppointment;
                                this.showNotification("Appointment updated successfully!", 'success');
                            }
                        }
                        this.closeModal('appointment-modal');
                        this.renderAppointments();
                    } else {
                        throw new Error("Failed to save appointment.");
                    }
                } catch (error) {
                    console.error("Error saving appointment:", error);
                    this.showNotification("Failed to save appointment.", 'error');
                }
            },

            editAppointment(id) {
                const appointment = this.data.appointments.find(a => a.id === id);
                if (appointment) {
                    this.elements.appointmentForm.querySelector('#appointment-id').value = appointment.id;
                    this.elements.appointmentForm.querySelector('#appointment-doctor-input').value = appointment.doctor;
                    this.elements.appointmentForm.querySelector('#appointment-date-input').value = appointment.date;
                    this.elements.appointmentForm.querySelector('#appointment-time-input').value = appointment.time;
                    this.elements.appointmentForm.querySelector('#appointment-location-input').value = appointment.location;
                    this.elements.appointmentForm.querySelector('#appointment-notes-input').value = appointment.notes;
                    document.getElementById('appointment-modal-title').textContent = 'Edit Appointment';
                    this.openModal('appointment-modal');
                }
            },

            async deleteAppointment(id) {
                if (!confirm("Are you sure you want to delete this appointment?")) return;
                try {
                    const response = await fetch(`/appointments/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        this.data.appointments = this.data.appointments.filter(a => a.id !== id);
                        this.renderAppointments();
                        this.showNotification("Appointment deleted successfully!", 'success');
                    } else {
                        throw new Error("Failed to delete appointment.");
                    }
                } catch (error) {
                    console.error("Error deleting appointment:", error);
                    this.showNotification("Failed to delete appointment.", 'error');
                }
            },

            async saveEmergencyContact() {
                const form = this.elements.emergencyContactForm;
                const id = form.querySelector('#contact-id').value;
                const contact = {
                    name: form.querySelector('#contact-name-input').value,
                    relationship: form.querySelector('#contact-relationship-input').value,
                    phone: form.querySelector('#contact-phone-input').value
                };

                let url = '/emergency_contacts';
                let method = 'POST';

                if (id) {
                    url = `/emergency_contacts/${id}`;
                    method = 'PUT';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contact)
                    });

                    if (response.ok) {
                        const savedContact = await response.json();
                        if (method === 'POST') {
                            this.data.emergency_contacts.push(savedContact);
                            this.showNotification("Emergency contact added successfully!", 'success');
                        } else {
                            const index = this.data.emergency_contacts.findIndex(c => c.id === id);
                            if (index !== -1) {
                                this.data.emergency_contacts[index] = savedContact;
                                this.showNotification("Emergency contact updated successfully!", 'success');
                            }
                        }
                        this.closeModal('emergency-contact-modal');
                        this.renderEmergencyContacts();
                    } else {
                        throw new Error("Failed to save emergency contact.");
                    }
                } catch (error) {
                    console.error("Error saving contact:", error);
                    this.showNotification("Failed to save contact.", 'error');
                }
            },

            editEmergencyContact(id) {
                const contact = this.data.emergency_contacts.find(c => c.id === id);
                if (contact) {
                    this.elements.emergencyContactForm.querySelector('#contact-id').value = contact.id;
                    this.elements.emergencyContactForm.querySelector('#contact-name-input').value = contact.name;
                    this.elements.emergencyContactForm.querySelector('#contact-relationship-input').value = contact.relationship;
                    this.elements.emergencyContactForm.querySelector('#contact-phone-input').value = contact.phone;
                    document.getElementById('emergency-contact-modal-title').textContent = 'Edit Emergency Contact';
                    this.openModal('emergency-contact-modal');
                }
            },

            async deleteEmergencyContact(id) {
                if (!confirm("Are you sure you want to delete this contact?")) return;
                try {
                    const response = await fetch(`/emergency_contacts/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        this.data.emergency_contacts = this.data.emergency_contacts.filter(c => c.id !== id);
                        this.renderEmergencyContacts();
                        this.showNotification("Emergency contact deleted successfully!", 'success');
                    } else {
                        throw new Error("Failed to delete contact.");
                    }
                } catch (error) {
                    console.error("Error deleting contact:", error);
                    this.showNotification("Failed to delete contact.", 'error');
                }
            },

            // --- Utility Functions ---
            openMedicationModal() {
                const form = this.elements.medicationForm;
                form.reset();
                form.querySelector('#medication-id').value = '';
                document.getElementById('medication-modal-title').textContent = 'Add Medication';
                this.openModal('medication-modal');
            },
            openAppointmentModal() {
                const form = this.elements.appointmentForm;
                form.reset();
                form.querySelector('#appointment-id').value = '';
                document.getElementById('appointment-modal-title').textContent = 'Add Appointment';
                this.openModal('appointment-modal');
            },
            openEmergencyContactModal() {
                const form = this.elements.emergencyContactForm;
                form.reset();
                form.querySelector('#contact-id').value = '';
                document.getElementById('emergency-contact-modal-title').textContent = 'Add Emergency Contact';
                this.openModal('emergency-contact-modal');
            },

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add('show');
            },

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('show');
            },
            
            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.classList.add('notification', type, 'slide-in-right');
                notification.innerHTML = `
                    <div class="notification-header">
                        <h5 class="notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</h5>
                        <button class="notification-close" onclick="this.closest('.notification').remove()">&times;</button>
                    </div>
                    <p class="notification-message">${message}</p>
                `;
                this.elements.notificationsContainer.appendChild(notification);
                setTimeout(() => {
                    notification.classList.remove('slide-in-right');
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            },

            calculateBmi() {
                const weight = parseFloat(document.getElementById('weight').value);
                const height = parseFloat(document.getElementById('height').value);
                const resultCard = document.getElementById('bmi-result-card');
                const bmiValue = document.getElementById('bmi-value');
                const bmiCategory = document.getElementById('bmi-category');

                if (isNaN(weight) || isNaN(height) || weight <= 0 || height <= 0) {
                    this.showNotification("Please enter valid weight and height.", 'error');
                    resultCard.classList.add('hidden');
                    return;
                }

                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(2);
                let category = '';

                if (bmi < 18.5) {
                    category = 'Underweight';
                } else if (bmi >= 18.5 && bmi < 24.9) {
                    category = 'Normal weight';
                } else if (bmi >= 25 && bmi < 29.9) {
                    category = 'Overweight';
                } else {
                    category = 'Obesity';
                }

                bmiValue.textContent = bmi;
                bmiCategory.textContent = category;
                resultCard.classList.remove('hidden');
            },
            
            setupThemeToggle() {
                const isDarkMode = localStorage.getItem('theme') === 'dark';
                this.elements.themeToggle.checked = isDarkMode;
                document.body.classList.toggle('dark-theme', isDarkMode);

                this.elements.themeToggle.addEventListener('change', () => {
                    const isDark = this.elements.themeToggle.checked;
                    document.body.classList.toggle('dark-theme', isDark);
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                });
            },

            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },

            checkReminders() {
                const now = new Date();
                const upcomingThreshold = 30 * 60 * 1000; // 30 minutes in milliseconds

                // Medication reminders
                if (this.data.medications) {
                    this.data.medications.forEach(med => {
                        const medTime = med.time;
                        if (!medTime) return;

                        const [hours, minutes] = medTime.split(':').map(Number);
                        const medDateTime = new Date();
                        medDateTime.setHours(hours, minutes, 0, 0);

                        const timeDiff = medDateTime.getTime() - now.getTime();
                        
                        if (timeDiff > 0 && timeDiff <= upcomingThreshold) {
                            const notificationKey = `med-${med.id}-${med.time}`;
                            if (!sessionStorage.getItem(notificationKey)) {
                                this.showNotification(`Upcoming medication: Take ${med.dosage} of ${med.name}`, 'warning');
                                sessionStorage.setItem(notificationKey, 'true');
                            }
                        }
                    });
                }

                // Appointment reminders
                if (this.data.appointments) {
                    this.data.appointments.forEach(appt => {
                         const timeMatch = appt.time.match(/(\d{1,2}):?(\d{2})?\s?(AM|PM)?/i);
                         if (timeMatch) {
                            let hours = parseInt(timeMatch[1], 10);
                            const minutes = timeMatch[2] ? parseInt(timeMatch[2], 10) : 0;
                            const period = timeMatch[3];

                            if (period && period.toLowerCase() === 'pm' && hours < 12) hours += 12;
                            if (period && period.toLowerCase() === 'am' && hours === 12) hours = 0;

                            const apptTime = new Date();
                            apptTime.setHours(hours, minutes, 0, 0);

                            const timeDiff = apptTime.getTime() - now.getTime();
                            if (timeDiff > 0 && timeDiff <= upcomingThreshold) {
                                const notificationKey = `appt-${appt.id}`;
                                 if (!sessionStorage.getItem(notificationKey)) {
                                    this.showNotification(`Upcoming appointment with ${appt.doctor} at ${appt.time}`, 'warning');
                                    sessionStorage.setItem(notificationKey, 'true');
                                }
                            }
                         }
                    });
                }
            }
        };

        // Start checking for reminders every minute
        setInterval(() => app.checkReminders(), 60000);

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>